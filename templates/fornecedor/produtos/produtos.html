{% extends "fornecedor/base.html" %}

{#
    Template: Listagem de Produtos do Fornecedor
    Descrição: Página para listar e gerenciar produtos do fornecedor
    Estende: fornecedor/base.html
#}

{% from 'components/product_card.html' import product_card %}
{% from 'components/confirmation_modal.html' import confirmation_modal %}
{% from 'components/search_form.html' import search_form %}
{% from 'components/empty_state.html' import empty_state %}
{% from 'components/breadcrumbs.html' import breadcrumbs %}

{% block fornecedor_titulo %}Meus Produtos{% endblock %}
{% block sidebar_active %}produtos{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/css/fornecedor_produtos_listar.css">
{% endblock %}

{% block fornecedor_conteudo %}
<div class="container-fluid px-4">
    <!-- Breadcrumbs -->
    {{ breadcrumbs([
        {'label': 'Home', 'url': '/fornecedor/home'},
        {'label': 'Meus Produtos'}
    ]) }}

    <!-- Header da página -->
    <section class="page-header mb-4">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <h1 class="page-title">Meus Produtos</h1>
                <p class="page-subtitle">Gerencie todos os seus produtos cadastrados</p>
            </div>
            <div class="col-lg-4 text-end">
                <div class="stats-container">
                    <div class="stat-item">
                        <span class="stat-number">{{ produtos|length if produtos else 0 }}</span>
                        <span class="stat-label">Total</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Busca -->
    <section class="search-section mb-4">
        {{ search_form(
            action='/fornecedor/produtos/buscar',
            fields=[
                {'name': 'id', 'type': 'number', 'label': 'Buscar por ID', 'placeholder': 'Digite o ID do produto'},
                {'name': 'nome', 'type': 'text', 'label': 'Buscar por Nome', 'placeholder': 'Digite o nome do produto'}
            ],
            clear_url='/fornecedor/produtos/listar'
        ) }}
    </section>

    <!-- Botão Cadastrar Novo Produto -->
    <section class="action-section mb-4">
        <a href="/fornecedor/produtos/inserir" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i> Cadastrar Novo Produto
        </a>
    </section>

    <!-- Lista de Produtos -->
    <section class="products-section">
        {% if produtos %}
        <div class="products-grid" id="productsContainer">
            {% for produto in produtos %}
                {{ product_card(produto, show_actions=True) }}
            {% endfor %}
        </div>
        {% else %}
        {{ empty_state(
            icon='box-seam',
            title='Nenhum produto encontrado',
            description='Você ainda não cadastrou nenhum produto ou a busca não retornou resultados.',
            action_url='/fornecedor/produtos/inserir',
            action_text='Cadastrar Primeiro Produto',
            action_icon='plus-circle'
        ) }}
        {% endif %}
    </section>
</div>

<!-- Modais -->
{{ confirmation_modal(
    modal_id='deleteModal',
    title='Confirmar Exclusão',
    icon='trash',
    icon_class='text-danger',
    message='<p>Tem certeza que deseja excluir o produto <strong id="productNameToDelete"></strong>?</p><p class="text-muted">Esta ação não pode ser desfeita.</p>',
    confirm_text='Excluir',
    confirm_class='btn-danger'
) }}
{% endblock %}

{% block fornecedor_scripts %}
<script>
    // Função para confirmar exclusão de produto
    function confirmDelete(productId, productName) {
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        document.getElementById('productNameToDelete').textContent = productName;

        const confirmBtn = document.getElementById('deleteModalConfirmBtn');
        confirmBtn.onclick = function() {
            deleteProduct(productId);
        };

        modal.show();
    }

    // Função para deletar produto
    function deleteProduct(productId) {
        fetch(`/fornecedor/produtos/deletar/${productId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Recarregar página ou remover elemento do DOM
                location.reload();
            } else {
                alert('Erro ao excluir produto: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir produto');
        });
    }
</script>
{% endblock %}
