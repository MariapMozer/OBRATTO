{% extends "fornecedor/base.html" %}

{#
    Template: Listagem de Produtos do Fornecedor
    Descrição: Página para listar e gerenciar produtos do fornecedor
    Estende: fornecedor/base.html
#}

{% from 'components/product_card.html' import product_card %}
{% from 'components/confirmation_modal.html' import confirmation_modal %}
{% from 'components/search_form.html' import search_form %}
{% from 'components/empty_state.html' import empty_state %}
{% from 'components/breadcrumbs.html' import breadcrumbs %}

{% block fornecedor_titulo %}Meus Produtos{% endblock %}
{% block sidebar_active %}produtos{% endblock %}

{% block css %}
<link rel="stylesheet" href="/static/css/home.css">
<link rel="stylesheet" href="/static/css/home_fornecedor.css">
<link rel="stylesheet" href="/static/css/produtos_fornecedor.css">
{% endblock %}

{% block fornecedor_conteudo %}
<div class="container-fluid px-4">
    <!-- Header da página -->
    <div class="row mb-4 align-items-center">
        <div class="col">
            <h1 class="page-title">Meus Produtos</h1>
            <p class="page-subtitle">Gerencie e visualize todos os seus produtos cadastrados</p>
        </div>
        <div class="col-auto text-end">
            <a href="/fornecedor/produtos/inserir" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i> Cadastrar Produto
            </a>
        </div>
    </div>

    <!-- Cards de Estatísticas -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm stats-card">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Total de Produtos</h6>
                            <h2 class="mb-0">{{ produtos|length if produtos else 0 }}</h2>
                        </div>
                        <i class="bi bi-box-seam stats-icon"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm stats-card">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Em Estoque</h6>
                            <h2 class="mb-0">{% if produtos %}{{ produtos|length }}{% else %}0{% endif %}</h2>
                        </div>
                        <i class="bi bi-check-circle stats-icon"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm stats-card">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Fora de Estoque</h6>
                            <h2 class="mb-0">0</h2>
                        </div>
                        <i class="bi bi-exclamation-circle stats-icon"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm stats-card">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-title mb-1">Preço Médio</h6>
                            <h2 class="mb-0">R$ 0</h2>
                        </div>
                        <i class="bi bi-currency-dollar stats-icon"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de Filtros e Busca -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm filter-card">
                <div class="card-body">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="searchInput" class="form-label">Buscar Produto</label>
                            <input 
                                type="text" 
                                class="form-control" 
                                id="searchInput" 
                                placeholder="Digite o nome ou ID do produto..."
                                onkeyup="filterProducts()"
                            >
                        </div>
                        <div class="col-md-3">
                            <label for="sortSelect" class="form-label">Ordenar por</label>
                            <select class="form-select" id="sortSelect" onchange="filterProducts()">
                                <option value="name-asc">Nome (A-Z)</option>
                                <option value="name-desc">Nome (Z-A)</option>
                                <option value="price-asc">Preço (Menor)</option>
                                <option value="price-desc">Preço (Maior)</option>
                                <option value="newest">Mais Recente</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="viewSelect" class="form-label">Visualização</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="view" id="viewGrid" value="grid" checked onchange="changeView('grid')">
                                <label class="btn btn-outline-secondary" for="viewGrid">
                                    <i class="bi bi-grid-3x3-gap"></i> Grade
                                </label>
                                <input type="radio" class="btn-check" name="view" id="viewList" value="list" onchange="changeView('list')">
                                <label class="btn btn-outline-secondary" for="viewList">
                                    <i class="bi bi-list-ul"></i> Lista
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Produtos -->
    <section class="products-section">
        {% if produtos and produtos|length > 0 %}
            <div class="products-grid" id="productsGrid">
                {% for produto in produtos %}
                    <div class="product-item" data-product-name="{{ produto.nome }}" data-product-price="{{ produto.preco }}">
                        <div class="product-card">
                            <div class="product-image-wrapper">
                                <img src="{{ produto.foto if produto.foto else 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400&h=300&fit=crop' }}" alt="{{ produto.nome }}" class="product-image">
                                <div class="product-overlay">
                                    <a href="/fornecedor/produtos/alterar/{{ produto.id_produto }}" class="btn btn-sm btn-primary me-2">
                                        <i class="bi bi-pencil"></i> Editar
                                    </a>
                                    <button class="btn btn-sm btn-danger" onclick="confirmDelete({{ produto.id_produto }}, '{{ produto.nome }}')">
                                        <i class="bi bi-trash"></i> Deletar
                                    </button>
                                </div>
                            </div>
                            <div class="product-info">
                                <h5 class="product-name">{{ produto.nome }}</h5>
                                <p class="product-description">{{ produto.descricao[:60] }}{% if produto.descricao|length > 60 %}...{% endif %}</p>
                                <div class="product-footer">
                                    <span class="product-price">R$ {{ "%.2f"|format(produto.preco) }}</span>
                                    <span class="product-stock">
                                        <i class="bi bi-box-seam"></i>
                                        {{ produto.quantidade if produto.quantidade else 0 }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-box-seam"></i>
                </div>
                <h5>Nenhum produto cadastrado</h5>
                <p>Você ainda não cadastrou nenhum produto. Comece agora mesmo!</p>
                <a href="/fornecedor/produtos/inserir" class="btn btn-primary mt-3">
                    <i class="bi bi-plus-circle me-2"></i> Cadastrar Primeiro Produto
                </a>
            </div>
        {% endif %}
    </section>
</div>

<!-- Modais -->
{{ confirmation_modal(
    modal_id='deleteModal',
    title='Confirmar Exclusão',
    icon='trash',
    icon_class='text-danger',
    message='<p>Tem certeza que deseja excluir o produto <strong id="productNameToDelete"></strong>?</p><p class="text-muted">Esta ação não pode ser desfeita.</p>',
    confirm_text='Excluir',
    confirm_class='btn-danger'
) }}
{% endblock %}

{% block fornecedor_scripts %}
<script src="/static/js/produtos_fornecedor.js"></script>
<script>
    // Função para confirmar exclusão de produto
    function confirmDelete(productId, productName) {
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        document.getElementById('productNameToDelete').textContent = productName;

        const confirmBtn = document.getElementById('deleteModalConfirmBtn');
        confirmBtn.onclick = function() {
            deleteProduct(productId);
        };

        modal.show();
    }

    // Função para deletar produto
    function deleteProduct(productId) {
        fetch(`/fornecedor/produtos/deletar/${productId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao excluir produto: ' + (data.message || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao excluir produto');
        });
    }
</script>
{% endblock %}
