{% extends "prestador/base.html" %}

{#
    Template: Meus Serviços (Prestador)
    Descrição: Lista todos os serviços cadastrados pelo prestador
    Estende: prestador/base.html
#}

{% from 'components/service_card.html' import service_card %}
{% from 'components/breadcrumbs.html' import breadcrumbs %}
{% from 'components/search_form.html' import search_form %}
{% from 'components/empty_state.html' import empty_state %}
{% from 'components/pagination.html' import pagination %}
{% from 'components/confirmation_modal.html' import confirmation_modal %}

{% block prestador_titulo %}Meus Serviços{% endblock %}

{% block prestador_conteudo %}
<div class="container-fluid px-4 py-4">
    <!-- Breadcrumbs -->
    {{ breadcrumbs(items=[
        {'text': 'Home', 'url': '/prestador/home'},
        {'text': 'Meus Serviços', 'active': True}
    ]) }}

    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Meus Serviços</h1>
            <p class="text-muted mb-0">Gerencie os serviços que você oferece</p>
        </div>
        <a href="/prestador/servicos/novo" class="btn btn-primary">
            <i class="bi bi-plus-circle me-2"></i>Novo Serviço
        </a>
    </div>

    <!-- Search -->
    <div class="card mb-4">
        <div class="card-body">
            {{ search_form(
                action_url='/prestador/servicos',
                placeholder='Buscar por nome, categoria ou descrição...',
                show_filters=True,
                filters=[
                    {
                        'name': 'status',
                        'label': 'Status',
                        'type': 'select',
                        'options': [
                            {'value': '', 'text': 'Todos'},
                            {'value': 'ativo', 'text': 'Ativo'},
                            {'value': 'inativo', 'text': 'Inativo'},
                            {'value': 'rascunho', 'text': 'Rascunho'}
                        ]
                    },
                    {
                        'name': 'categoria',
                        'label': 'Categoria',
                        'type': 'select',
                        'options': categorias|default([
                            {'value': '', 'text': 'Todas'},
                            {'value': '1', 'text': 'Reparos'},
                            {'value': '2', 'text': 'Limpeza'},
                            {'value': '3', 'text': 'Manutenção'}
                        ])
                    }
                ]
            ) }}
        </div>
    </div>

    <!-- Services Grid -->
    {% if servicos and servicos|length > 0 %}
    <div class="row g-4 mb-4">
        {% for servico in servicos %}
        <div class="col-lg-4 col-md-6">
            {{ service_card(
                servico=servico,
                show_actions=True,
                edit_url='/prestador/servicos/editar/' ~ servico.id,
                gallery_url='/prestador/servicos/' ~ servico.id ~ '/galeria',
                delete_handler='confirmDeleteServico',
                card_class='h-100'
            ) }}
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total_pages and total_pages > 1 %}
    {{ pagination(
        current_page=current_page|default(1),
        total_pages=total_pages,
        base_url='/prestador/servicos'
    ) }}
    {% endif %}

    {% else %}
    <!-- Empty State -->
    {{ empty_state(
        icon='tools',
        title='Nenhum serviço cadastrado',
        message='Você ainda não cadastrou nenhum serviço. Comece cadastrando seu primeiro serviço para começar a receber solicitações!',
        action_url='/prestador/servicos/novo',
        action_text='Cadastrar Primeiro Serviço',
        action_icon='plus-circle'
    ) }}
    {% endif %}

    <!-- Statistics Summary -->
    {% if servicos_stats %}
    <div class="row g-3 mt-4">
        <div class="col-md-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h3 class="text-primary mb-0">{{ servicos_stats.total|default(0) }}</h3>
                    <small class="text-muted">Total de Serviços</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <h3 class="text-success mb-0">{{ servicos_stats.ativos|default(0) }}</h3>
                    <small class="text-muted">Ativos</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <h3 class="text-info mb-0">{{ servicos_stats.solicitacoes|default(0) }}</h3>
                    <small class="text-muted">Solicitações</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <h3 class="text-warning mb-0">{{ servicos_stats.media_avaliacao|default('0.0') }}</h3>
                    <small class="text-muted">Avaliação Média</small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Confirmation Modal -->
{{ confirmation_modal(
    modal_id='deleteServicoModal',
    title='Confirmar Exclusão',
    message='Tem certeza que deseja excluir este serviço? Esta ação não pode ser desfeita.',
    confirm_text='Excluir',
    cancel_text='Cancelar',
    confirm_class='btn-danger'
) }}

{% block prestador_scripts %}
<script>
let servicoToDelete = null;

function confirmDeleteServico(servicoId, servicoNome) {
    servicoToDelete = servicoId;
    const modal = new bootstrap.Modal(document.getElementById('deleteServicoModal'));
    const message = document.querySelector('#deleteServicoModal .modal-body p');
    message.textContent = `Tem certeza que deseja excluir o serviço "${servicoNome}"? Esta ação não pode ser desfeita.`;
    modal.show();
}

// Event listener para o botão de confirmação
document.addEventListener('DOMContentLoaded', function() {
    const confirmBtn = document.querySelector('#deleteServicoModal .btn-danger');
    if (confirmBtn) {
        confirmBtn.addEventListener('click', function() {
            if (servicoToDelete) {
                window.location.href = `/prestador/servicos/excluir/${servicoToDelete}`;
            }
        });
    }
});
</script>
{% endblock %}
{% endblock %}
